---
#
#
#
platform: template
sensors:
#  eds_lavest_price_tomorrow:
#    friendly_name: "Laveste el-pris i morgen"
#    unit_of_measurement: "Kr"
#    value_template: >
#      {{ state_attr('sensor.energi_data_service', 'tomorrow_min').price }}
#
#
# ---- 
#
# --- ROBUSTE TEMPLATE-SENSORER TIL MIN/MAKS/MEAN I DAG/IMORGEN ---

  # Laveste pris i dag
  lavest_price_today:
    friendly_name: "Laveste el-pris i dag"
    unit_of_measurement: "DKK/kWh"
    availability_template: >
      {% set t = state_attr('sensor.energi_data_service','today_min') | default({}, true) %}
      {{ t is mapping and t.get('price') is not none }}
    value_template: >
      {% set t = state_attr('sensor.energi_data_service','today_min') | default({}, true) %}
      {{ t.get('price') | float }}
    attribute_templates:
      from: >
        {{ (state_attr('sensor.energi_data_service','today_min') | default({}, true)).get('from') }}
      to: >
        {{ (state_attr('sensor.energi_data_service','today_min') | default({}, true)).get('to') }}

  # Laveste pris i morgen
  lavest_price_tomorrow:
    friendly_name: "Laveste el-pris i morgen"
    unit_of_measurement: "DKK/kWh"
    availability_template: >
      {% set t = state_attr('sensor.energi_data_service','tomorrow_min') | default({}, true) %}
      {{ t is mapping and t.get('price') is not none }}
    value_template: >
      {% set t = state_attr('sensor.energi_data_service','tomorrow_min') | default({}, true) %}
      {{ t.get('price') | float }}
    attribute_templates:
      from: >
        {{ (state_attr('sensor.energi_data_service','tomorrow_min') | default({}, true)).get('from') }}
      to: >
        {{ (state_attr('sensor.energi_data_service','tomorrow_min') | default({}, true)).get('to') }}

  # Højeste pris i dag
  max_price_today:
    friendly_name: "Højeste el-pris i dag"
    unit_of_measurement: "DKK/kWh"
    availability_template: >
      {% set t = state_attr('sensor.energi_data_service','today_max') | default({}, true) %}
      {{ t is mapping and t.get('price') is not none }}
    value_template: >
      {% set t = state_attr('sensor.energi_data_service','today_max') | default({}, true) %}
      {{ t.get('price') | float }}
    attribute_templates:
      from: >
        {{ (state_attr('sensor.energi_data_service','today_max') | default({}, true)).get('from') }}
      to: >
        {{ (state_attr('sensor.energi_data_service','today_max') | default({}, true)).get('to') }}

  # Højeste pris i morgen
  max_price_tomorrow:
    friendly_name: "Højeste el-pris i morgen"
    unit_of_measurement: "DKK/kWh"
    availability_template: >
      {% set t = state_attr('sensor.energi_data_service','tomorrow_max') | default({}, true) %}
      {{ t is mapping and t.get('price') is not none }}
    value_template: >
      {% set t = state_attr('sensor.energi_data_service','tomorrow_max') | default({}, true) %}
      {{ t.get('price') | float }}
    attribute_templates:
      from: >
        {{ (state_attr('sensor.energi_data_service','tomorrow_max') | default({}, true)).get('from') }}
      to: >
        {{ (state_attr('sensor.energi_data_service','tomorrow_max') | default({}, true)).get('to') }}

  # Gennemsnit i dag
  gennemsnit_pris_today:
    friendly_name: "Gennemsnit el-pris i dag"
    unit_of_measurement: "DKK/kWh"
    availability_template: >
      {{ (state_attr('sensor.energi_data_service','today_mean') | default(None)) is not none
          or states('sensor.energi_data_service') | is_number }}
    value_template: >
      {{ (state_attr('sensor.energi_data_service','today_mean')
          | default(states('sensor.energi_data_service'))) | float }}

  # Gennemsnit i morgen
  gennemsnit_pris_tomorrow:
    friendly_name: "Gennemsnit el-pris i morgen"
    unit_of_measurement: "DKK/kWh"
    availability_template: >
      {{ (state_attr('sensor.energi_data_service','tomorrow_mean') | default(None)) is not none }}
    value_template: >
      {{ (state_attr('sensor.energi_data_service','tomorrow_mean') | default(none)) | float }}

  # Næste opdatering (tekst/datetime)
  next_update:
    friendly_name: "EDS - næste opdatering"
    value_template: >
      {{ state_attr('sensor.energi_data_service','next_data_update') }}

  # Hvornår er det billigst (timestamp)
  lowest_prices:
    friendly_name: "EDS – laveste pris tidspkt."
    availability_template: >
      {{ (state_attr('sensor.energi_data_service','today') | default([], true)) | length > 0 }}
    value_template: >
      {% set today = state_attr('sensor.energi_data_service','today') | default([], true) %}
      {% set tomorrow = state_attr('sensor.energi_data_service','tomorrow') | default([], true) %}
      {% set series = today + tomorrow %}
      {% set start = now().hour %}
      {% set tail = series[start:] if series|length > start else [] %}
      {% if tail|length == 0 %}
        {{ none }}
      {% else %}
        {% set idx = tail.index(tail|min) %}
        {{ (today_at('00:00') + timedelta(hours=start+idx)).isoformat() }}
      {% endif %}

  # Pænt format (dd-mm-YYYY HH:MM)
  lowest_prices_nice_format:
    friendly_name: "Hvornår er strømmen billigst"
    icon_template: mdi:currency-usd
    value_template: >
      {% set ts = states('sensor.lowest_prices') %}
      {% if ts in ['unknown','unavailable','none',''] %}
        unknown
      {% else %}
        {{ as_timestamp(ts) | timestamp_custom('%d-%m-%Y %H:%M', true) }}
      {% endif %}

  # Kun tidspunkt (HH:MM)
  elpris_lowest_prices_nice_format:
    friendly_name: "Hvornår er strømmen billigst (tid)"
    icon_template: mdi:currency-usd
    value_template: >
      {% set ts = states('sensor.lowest_prices') %}
      {% if ts in ['unknown','unavailable','none',''] %}
        unknown
      {% else %}
        {{ as_timestamp(ts) | timestamp_custom('%H:%M', true) }}
      {% endif %}

  # prisen på nuværende tidspunkt
  #el_omkostning_rate:
  #  friendly_name: "El-omkostning (rate)"
  #  unit_of_measurement: "DKK/h"
  #  device_class: monetary
#    state_class: measurement
  #  availability_template: >
  #    {{ states('sensor.daily_energy')|is_number and
  #        states('sensor.energi_data_service')|is_number }}
  #  value_template: >
  #    {{ (states('sensor.daily_energy')|float(0) / 1000.0) *
  #        (states('sensor.energi_data_service')|float(0)) }}