- sensor:
    # Laveste pris i dag
    - name: "Laveste el-pris i dag"
      unique_id: lavest_price_today
      unit_of_measurement: "DKK/kWh"
      availability: >-
        {% set t = state_attr('sensor.energi_data_service','today_min') | default({}, true) %}
        {{ t is mapping and t.get('price') is not none }}
      state: >-
        {% set t = state_attr('sensor.energi_data_service','today_min') | default({}, true) %}
        {{ t.get('price') | float }}
      attributes:
        from: >-
          {{ (state_attr('sensor.energi_data_service','today_min') | default({}, true)).get('from') }}
        to: >-
          {{ (state_attr('sensor.energi_data_service','today_min') | default({}, true)).get('to') }}

    # Laveste pris i morgen
    - name: "Laveste el-pris i morgen"
      unique_id: lavest_price_tomorrow
      unit_of_measurement: "DKK/kWh"
      availability: >-
        {% set t = state_attr('sensor.energi_data_service','tomorrow_min') | default({}, true) %}
        {{ t is mapping and t.get('price') is not none }}
      state: >-
        {% set t = state_attr('sensor.energi_data_service','tomorrow_min') | default({}, true) %}
        {{ t.get('price') | float }}
      attributes:
        from: >-
          {{ (state_attr('sensor.energi_data_service','tomorrow_min') | default({}, true)).get('from') }}
        to: >-
          {{ (state_attr('sensor.energi_data_service','tomorrow_min') | default({}, true)).get('to') }}

    # Højeste pris i dag
    - name: "Højeste el-pris i dag"
      unique_id: max_price_today
      unit_of_measurement: "DKK/kWh"
      availability: >-
        {% set t = state_attr('sensor.energi_data_service','today_max') | default({}, true) %}
        {{ t is mapping and t.get('price') is not none }}
      state: >-
        {% set t = state_attr('sensor.energi_data_service','today_max') | default({}, true) %}
        {{ t.get('price') | float }}
      attributes:
        from: >-
          {{ (state_attr('sensor.energi_data_service','today_max') | default({}, true)).get('from') }}
        to: >-
          {{ (state_attr('sensor.energi_data_service','today_max') | default({}, true)).get('to') }}

    # Højeste pris i morgen
    - name: "Højeste el-pris i morgen"
      unique_id: max_price_tomorrow
      unit_of_measurement: "DKK/kWh"
      availability: >-
        {% set t = state_attr('sensor.energi_data_service','tomorrow_max') | default({}, true) %}
        {{ t is mapping and t.get('price') is not none }}
      state: >-
        {% set t = state_attr('sensor.energi_data_service','tomorrow_max') | default({}, true) %}
        {{ t.get('price') | float }}
      attributes:
        from: >-
          {{ (state_attr('sensor.energi_data_service','tomorrow_max') | default({}, true)).get('from') }}
        to: >-
          {{ (state_attr('sensor.energi_data_service','tomorrow_max') | default({}, true)).get('to') }}

    # Gennemsnit i dag
    - name: "Gennemsnit el-pris i dag"
      unique_id: gennemsnit_pris_today
      unit_of_measurement: "DKK/kWh"
      availability: >-
        {{ (state_attr('sensor.energi_data_service','today_mean') | default(None)) is not none
           or states('sensor.energi_data_service') | is_number }}
      state: >-
        {{ (state_attr('sensor.energi_data_service','today_mean')
            | default(states('sensor.energi_data_service'))) | float }}

    # Gennemsnit i morgen
    - name: "Gennemsnit el-pris i morgen"
      unique_id: gennemsnit_pris_tomorrow
      unit_of_measurement: "DKK/kWh"
      availability: >-
        {{ (state_attr('sensor.energi_data_service','tomorrow_mean') | default(None)) is not none }}
      state: >-
        {{ (state_attr('sensor.energi_data_service','tomorrow_mean') | default(None)) | float }}

    # Næste opdatering (tekst/datetime)
    - name: "EDS - næste opdatering"
      unique_id: next_update
      state: >-
        {{ state_attr('sensor.energi_data_service','next_data_update') }}

    # Hvornår er det billigst (timestamp ISO)
    - name: "EDS – laveste pris tidspkt."
      unique_id: lowest_prices
      availability: >-
        {{ (state_attr('sensor.energi_data_service','today') | default([], true)) | length > 0 }}
      state: >-
        {% set today = state_attr('sensor.energi_data_service','today') | default([], true) %}
        {% set tomorrow = state_attr('sensor.energi_data_service','tomorrow') | default([], true) %}
        {% set series = today + tomorrow %}
        {% set start = now().hour %}
        {% set tail = series[start:] if series|length > start else [] %}
        {% if tail|length == 0 %}
          {{ none }}
        {% else %}
          {% set idx = tail.index(tail|min) %}
          {{ (today_at('00:00') + timedelta(hours=start+idx)).isoformat() }}
        {% endif %}

    # Pænt format (dd-mm-YYYY HH:MM)
    - name: "Hvornår er strømmen billigst"
      unique_id: lowest_prices_nice_format
      icon: mdi:currency-usd
      state: >-
        {% set ts = states('sensor.lowest_prices') %}
        {% if ts in ['unknown','unavailable','none',''] %}
          unknown
        {% else %}
          {{ as_timestamp(ts) | timestamp_custom('%d-%m-%Y %H:%M', true) }}
        {% endif %}

    # Kun tidspunkt (HH:MM)
    - name: "Hvornår er strømmen billigst (tid)"
      unique_id: elpris_lowest_prices_nice_format
      icon: mdi:currency-usd
      state: >-
        {% set ts = states('sensor.lowest_prices') %}
        {% if ts in ['unknown','unavailable','none',''] %}
          unknown
        {% else %}
          {{ as_timestamp(ts) | timestamp_custom('%H:%M', true) }}
        {% endif %}

    - name: Historic Energy Price Percentiles
      unique_id: historic_energy_price_percentiles
      state: OK
      attributes:
        25th: "{{ states('sensor.average_energy_price_last_30d_mean') | float(0) + states('sensor.energy_price_last_30d_std') | float(0) * -0.63 }}"
        50th: "{{ states('sensor.average_energy_price_last_30d_mean') | float(0) + states('sensor.energy_price_last_30d_std') | float(0) * 0 }}"
        75th: "{{ states('sensor.average_energy_price_last_30d_mean') | float(0) + states('sensor.energy_price_last_30d_std') | float(0) * 0.57 }}"
        90th: "{{ states('sensor.average_energy_price_last_30d_mean') | float(0) + states('sensor.energy_price_last_30d_std') | float(0) * 1.29 }}"
        95th: "{{ states('sensor.average_energy_price_last_30d_mean') | float(0) + states('sensor.energy_price_last_30d_std') | float(0) * 1.65 }}"
        99th: "{{ states('sensor.average_energy_price_last_30d_mean') | float(0) + states('sensor.energy_price_last_30d_std') | float(0) * 2.33 }}"
        100th: "{{ states('sensor.average_energy_price_last_30d_mean') | float(0) + states('sensor.energy_price_last_30d_std') | float(0) * 3.9 }}"

    - name: "EDS pris (DKK/kWh)"
      unique_id: eds_price_dkk_per_kwh
      state: "{{ states('sensor.energi_data_service') | float(0) }}"
      unit_of_measurement: "DKK/kWh"
      device_class: monetary
#        state_class: measurement
      availability: >
        {{ states('sensor.energi_data_service') not in ['unknown','unavailable',''] }}
    
    - name: "El-omkostning (rate)"
      unique_id: el_omkostning_rate
      state: >  
        {{ (states('sensor.frient_energiforbrug_total_power')|float(0) / 1000)
            * (states('sensor.energi_data_service')|float(0)) }}
      unit_of_measurement: "DKK/h"
      device_class: monetary
#        state_class: measurement
      availability: >
        {{ states('sensor.frient_energiforbrug_total_power') not in ['unknown','unavailable','']
          and states('sensor.energi_data_service') not in ['unknown','unavailable',''] }}

    - name: "El - dagspris (estimat)"
      unique_id: el_dagspris_estimat
      unit_of_measurement: "DKK"
      state: >
        {{ (states('sensor.daily_energy')|float(0))
            * (state_attr('sensor.energi_data_service','today_mean')|float(0)) | round(2) }}
